# Task 11.5: CharacterService Implementation - Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Implement CharacterService with class eligibility calculation, character creation, and name/password validation to support Training Grounds character creation wizard

**Architecture:** Pure function service following existing patterns - no side effects, immutable state updates, comprehensive test coverage with real data (no mocks)

**Tech Stack:** Angular 20, TypeScript 5.5+, Jest, TDD methodology

**Prerequisites:** Tasks 1-11 complete (Race, Alignment, CharacterCreationService with stat rolling)

**Estimated Duration:** 1-2 days | **Target:** 20 new tests

---

## Part 1: Class Eligibility Calculation

### Step 1: Write failing tests for class eligibility

**Files:**
- Create: `src/services/__tests__/CharacterService.spec.ts`

```typescript
// src/services/__tests__/CharacterService.spec.ts
import { CharacterService } from '../CharacterService'
import { CharacterClass } from '../../types/CharacterClass'
import { BaseStats } from '../CharacterCreationService'

describe('CharacterService', () => {
  describe('getEligibleClasses', () => {
    it('returns Fighter when STR >= 11', () => {
      const stats: BaseStats = {
        strength: 11,
        intelligence: 8,
        piety: 8,
        vitality: 10,
        agility: 9,
        luck: 10
      }

      const eligible = CharacterService.getEligibleClasses(stats)
      expect(eligible).toContain(CharacterClass.FIGHTER)
    })

    it('excludes Fighter when STR < 11', () => {
      const stats: BaseStats = {
        strength: 10,
        intelligence: 8,
        piety: 8,
        vitality: 10,
        agility: 9,
        luck: 10
      }

      const eligible = CharacterService.getEligibleClasses(stats)
      expect(eligible).not.toContain(CharacterClass.FIGHTER)
    })

    it('returns Mage when IQ >= 11', () => {
      const stats: BaseStats = {
        strength: 8,
        intelligence: 11,
        piety: 8,
        vitality: 10,
        agility: 9,
        luck: 10
      }

      const eligible = CharacterService.getEligibleClasses(stats)
      expect(eligible).toContain(CharacterClass.MAGE)
    })

    it('returns Priest when PIE >= 11', () => {
      const stats: BaseStats = {
        strength: 8,
        intelligence: 8,
        piety: 11,
        vitality: 10,
        agility: 9,
        luck: 10
      }

      const eligible = CharacterService.getEligibleClasses(stats)
      expect(eligible).toContain(CharacterClass.PRIEST)
    })

    it('returns Thief when AGI >= 11', () => {
      const stats: BaseStats = {
        strength: 8,
        intelligence: 8,
        piety: 8,
        vitality: 10,
        agility: 11,
        luck: 10
      }

      const eligible = CharacterService.getEligibleClasses(stats)
      expect(eligible).toContain(CharacterClass.THIEF)
    })

    it('returns Bishop when IQ >= 12 and PIE >= 12', () => {
      const stats: BaseStats = {
        strength: 8,
        intelligence: 12,
        piety: 12,
        vitality: 10,
        agility: 9,
        luck: 10
      }

      const eligible = CharacterService.getEligibleClasses(stats)
      expect(eligible).toContain(CharacterClass.BISHOP)
    })

    it('excludes Bishop when IQ = 12 but PIE < 12', () => {
      const stats: BaseStats = {
        strength: 8,
        intelligence: 12,
        piety: 11,
        vitality: 10,
        agility: 9,
        luck: 10
      }

      const eligible = CharacterService.getEligibleClasses(stats)
      expect(eligible).not.toContain(CharacterClass.BISHOP)
    })

    it('returns Samurai when STR >= 15, IQ >= 11, PIE >= 10, VIT >= 14, AGI >= 10', () => {
      const stats: BaseStats = {
        strength: 15,
        intelligence: 11,
        piety: 10,
        vitality: 14,
        agility: 10,
        luck: 8
      }

      const eligible = CharacterService.getEligibleClasses(stats)
      expect(eligible).toContain(CharacterClass.SAMURAI)
    })

    it('returns Lord when STR >= 15, IQ >= 12, PIE >= 12, VIT >= 15, AGI >= 14, LUK >= 15', () => {
      const stats: BaseStats = {
        strength: 15,
        intelligence: 12,
        piety: 12,
        vitality: 15,
        agility: 14,
        luck: 15
      }

      const eligible = CharacterService.getEligibleClasses(stats)
      expect(eligible).toContain(CharacterClass.LORD)
    })

    it('returns Ninja when ALL stats >= 17', () => {
      const stats: BaseStats = {
        strength: 17,
        intelligence: 17,
        piety: 17,
        vitality: 17,
        agility: 17,
        luck: 17
      }

      const eligible = CharacterService.getEligibleClasses(stats)
      expect(eligible).toContain(CharacterClass.NINJA)
    })

    it('excludes Ninja when one stat is 16', () => {
      const stats: BaseStats = {
        strength: 17,
        intelligence: 17,
        piety: 17,
        vitality: 17,
        agility: 17,
        luck: 16 // One stat below 17
      }

      const eligible = CharacterService.getEligibleClasses(stats)
      expect(eligible).not.toContain(CharacterClass.NINJA)
    })

    it('returns multiple eligible classes', () => {
      const stats: BaseStats = {
        strength: 15,
        intelligence: 12,
        piety: 12,
        vitality: 14,
        agility: 11,
        luck: 10
      }

      const eligible = CharacterService.getEligibleClasses(stats)

      // Should qualify for: Fighter, Mage, Priest, Thief, Bishop, Samurai
      expect(eligible.length).toBeGreaterThanOrEqual(6)
      expect(eligible).toContain(CharacterClass.FIGHTER)
      expect(eligible).toContain(CharacterClass.MAGE)
      expect(eligible).toContain(CharacterClass.PRIEST)
      expect(eligible).toContain(CharacterClass.THIEF)
      expect(eligible).toContain(CharacterClass.BISHOP)
      expect(eligible).toContain(CharacterClass.SAMURAI)
    })
  })
})
```

### Step 2: Run test to verify it fails

Run: `npm test -- --ci --testPathPattern="CharacterService"`

Expected output:
```
FAIL src/services/__tests__/CharacterService.spec.ts
  ● Test suite failed to run
    Cannot find module '../CharacterService'
```

### Step 3: Implement CharacterService with class eligibility logic

**Files:**
- Create: `src/services/CharacterService.ts`

```typescript
// src/services/CharacterService.ts
import { CharacterClass } from '../types/CharacterClass'
import { BaseStats } from './CharacterCreationService'

/**
 * Class stat requirements based on authentic Wizardry mechanics
 */
const CLASS_REQUIREMENTS: Record<CharacterClass, Partial<BaseStats>> = {
  [CharacterClass.FIGHTER]: { strength: 11 },
  [CharacterClass.MAGE]: { intelligence: 11 },
  [CharacterClass.PRIEST]: { piety: 11 },
  [CharacterClass.THIEF]: { agility: 11 },
  [CharacterClass.BISHOP]: { intelligence: 12, piety: 12 },
  [CharacterClass.SAMURAI]: {
    strength: 15,
    intelligence: 11,
    piety: 10,
    vitality: 14,
    agility: 10
  },
  [CharacterClass.LORD]: {
    strength: 15,
    intelligence: 12,
    piety: 12,
    vitality: 15,
    agility: 14,
    luck: 15
  },
  [CharacterClass.NINJA]: {
    strength: 17,
    intelligence: 17,
    piety: 17,
    vitality: 17,
    agility: 17,
    luck: 17
  }
}

/**
 * CharacterService - Character management and validation
 *
 * Features:
 * - Class eligibility calculation based on stat requirements
 * - Character creation with validation
 * - Name and password validation
 */
export class CharacterService {
  /**
   * Calculate which classes a character is eligible for based on their stats.
   *
   * Returns array of eligible CharacterClass values.
   */
  static getEligibleClasses(stats: BaseStats): CharacterClass[] {
    const eligible: CharacterClass[] = []

    for (const [className, requirements] of Object.entries(CLASS_REQUIREMENTS)) {
      if (this.meetsRequirements(stats, requirements)) {
        eligible.push(className as CharacterClass)
      }
    }

    return eligible
  }

  /**
   * Check if character stats meet the requirements for a class.
   */
  private static meetsRequirements(
    stats: BaseStats,
    requirements: Partial<BaseStats>
  ): boolean {
    for (const [stat, required] of Object.entries(requirements)) {
      const statKey = stat as keyof BaseStats
      if (stats[statKey] < required) {
        return false
      }
    }
    return true
  }
}
```

### Step 4: Run test to verify it passes

Run: `npm test -- --ci --testPathPattern="CharacterService"`

Expected output:
```
PASS src/services/__tests__/CharacterService.spec.ts
  CharacterService
    getEligibleClasses
      ✓ returns Fighter when STR >= 11
      ✓ excludes Fighter when STR < 11
      ✓ returns Mage when IQ >= 11
      ✓ returns Priest when PIE >= 11
      ✓ returns Thief when AGI >= 11
      ✓ returns Bishop when IQ >= 12 and PIE >= 12
      ✓ excludes Bishop when IQ = 12 but PIE < 12
      ✓ returns Samurai when STR >= 15, IQ >= 11, PIE >= 10, VIT >= 14, AGI >= 10
      ✓ returns Lord when STR >= 15, IQ >= 12, PIE >= 12, VIT >= 15, AGI >= 14, LUK >= 15
      ✓ returns Ninja when ALL stats >= 17
      ✓ excludes Ninja when one stat is 16
      ✓ returns multiple eligible classes

Test Suites: 1 passed, 1 total
Tests:       12 passed, 12 total
```

### Step 5: Commit

```bash
git add src/services/CharacterService.ts src/services/__tests__/CharacterService.spec.ts
git commit -m "feat(character): implement class eligibility calculation

- Calculate eligible classes based on stat requirements
- Support all 8 classes (Fighter, Mage, Priest, Thief, Bishop, Samurai, Lord, Ninja)
- Fighter: STR 11+
- Mage: IQ 11+
- Priest: PIE 11+
- Thief: AGI 11+
- Bishop: IQ 12+, PIE 12+
- Samurai: STR 15+, IQ 11+, PIE 10+, VIT 14+, AGI 10+
- Lord: STR 15+, IQ 12+, PIE 12+, VIT 15+, AGI 14+, LUK 15+
- Ninja: ALL stats 17+ (extremely rare!)
- 12 tests passing

Part of Phase 5: CharacterService implementation"
```

---

## Part 2: Name and Password Validation

### Step 1: Write failing tests for name/password validation

**Files:**
- Modify: `src/services/__tests__/CharacterService.spec.ts`

Add to existing test file:

```typescript
  describe('validateCharacterName', () => {
    it('accepts valid name (alphanumeric + space)', () => {
      expect(CharacterService.validateCharacterName('Gandalf')).toEqual({ valid: true })
      expect(CharacterService.validateCharacterName('Sir Lancelot')).toEqual({ valid: true })
      expect(CharacterService.validateCharacterName('Merlin 2')).toEqual({ valid: true })
    })

    it('rejects empty name', () => {
      const result = CharacterService.validateCharacterName('')
      expect(result.valid).toBe(false)
      expect(result.error).toContain('required')
    })

    it('rejects name > 15 characters', () => {
      const result = CharacterService.validateCharacterName('ThisNameIsTooLong')
      expect(result.valid).toBe(false)
      expect(result.error).toContain('15 characters')
    })

    it('rejects name with special characters', () => {
      const result = CharacterService.validateCharacterName('Gandalf!')
      expect(result.valid).toBe(false)
      expect(result.error).toContain('letters, numbers, and spaces')
    })

    it('accepts name with exactly 15 characters', () => {
      expect(CharacterService.validateCharacterName('FifteenCharsNow')).toEqual({ valid: true })
    })
  })

  describe('validatePassword', () => {
    it('accepts valid password (4-8 chars alphanumeric)', () => {
      expect(CharacterService.validatePassword('pass')).toEqual({ valid: true })
      expect(CharacterService.validatePassword('12345678')).toEqual({ valid: true })
      expect(CharacterService.validatePassword('Test123')).toEqual({ valid: true })
    })

    it('rejects empty password', () => {
      const result = CharacterService.validatePassword('')
      expect(result.valid).toBe(false)
      expect(result.error).toContain('required')
    })

    it('rejects password < 4 characters', () => {
      const result = CharacterService.validatePassword('abc')
      expect(result.valid).toBe(false)
      expect(result.error).toContain('4-8 characters')
    })

    it('rejects password > 8 characters', () => {
      const result = CharacterService.validatePassword('toolongpassword')
      expect(result.valid).toBe(false)
      expect(result.error).toContain('4-8 characters')
    })

    it('rejects password with special characters', () => {
      const result = CharacterService.validatePassword('pass!')
      expect(result.valid).toBe(false)
      expect(result.error).toContain('letters and numbers')
    })
  })
```

### Step 2: Run test to verify it fails

Run: `npm test -- --ci --testPathPattern="CharacterService"`

Expected: FAIL (validateCharacterName/validatePassword not defined)

### Step 3: Implement validation methods

**Files:**
- Modify: `src/services/CharacterService.ts`

Add to CharacterService:

```typescript
export interface ValidationResult {
  valid: boolean
  error?: string
}

export class CharacterService {
  // ... existing getEligibleClasses method ...

  /**
   * Validate character name.
   *
   * Rules:
   * - Required (not empty)
   * - Max 15 characters
   * - Alphanumeric + spaces only
   */
  static validateCharacterName(name: string): ValidationResult {
    if (!name || name.trim().length === 0) {
      return { valid: false, error: 'Name is required' }
    }

    if (name.length > 15) {
      return { valid: false, error: 'Name must be 15 characters or less' }
    }

    if (!/^[a-zA-Z0-9 ]+$/.test(name)) {
      return {
        valid: false,
        error: 'Name must contain only letters, numbers, and spaces'
      }
    }

    return { valid: true }
  }

  /**
   * Validate character password.
   *
   * Rules:
   * - Required (not empty)
   * - 4-8 characters
   * - Alphanumeric only
   */
  static validatePassword(password: string): ValidationResult {
    if (!password || password.length === 0) {
      return { valid: false, error: 'Password is required' }
    }

    if (password.length < 4 || password.length > 8) {
      return { valid: false, error: 'Password must be 4-8 characters' }
    }

    if (!/^[a-zA-Z0-9]+$/.test(password)) {
      return {
        valid: false,
        error: 'Password must contain only letters and numbers'
      }
    }

    return { valid: true }
  }
}
```

### Step 4: Run test to verify it passes

Run: `npm test -- --ci --testPathPattern="CharacterService"`

Expected: PASS (all 22 tests passing - 12 class eligibility + 10 validation)

### Step 5: Commit

```bash
git add src/services/CharacterService.ts src/services/__tests__/CharacterService.spec.ts
git commit -m "feat(character): implement name and password validation

- Validate character names (1-15 chars, alphanumeric + space)
- Validate passwords (4-8 chars, alphanumeric only)
- Return structured validation results with error messages
- 10 tests passing (22 total)

Part of Phase 5: CharacterService implementation"
```

---

## Part 3: Character Creation

### Step 1: Write failing tests for character creation

**Files:**
- Modify: `src/services/__tests__/CharacterService.spec.ts`

Add to existing test file:

```typescript
import { CharacterStatus } from '../../types/CharacterStatus'
import { Race } from '../../types/Race'
import { Alignment } from '../../types/Alignment'

  describe('createCharacter', () => {
    const validStats: BaseStats = {
      strength: 15,
      intelligence: 12,
      piety: 12,
      vitality: 14,
      agility: 11,
      luck: 10
    }

    it('creates character with all required fields', () => {
      const char = CharacterService.createCharacter({
        name: 'Gandalf',
        password: 'wizard',
        race: Race.HUMAN,
        alignment: Alignment.GOOD,
        stats: validStats,
        selectedClass: CharacterClass.MAGE
      })

      expect(char.name).toBe('Gandalf')
      expect(char.password).toBe('wizard')
      expect(char.race).toBe(Race.HUMAN)
      expect(char.alignment).toBe(Alignment.GOOD)
      expect(char.class).toBe(CharacterClass.MAGE)
      expect(char.level).toBe(1)
      expect(char.status).toBe(CharacterStatus.OK)
    })

    it('assigns stats from input', () => {
      const char = CharacterService.createCharacter({
        name: 'Test',
        password: 'test',
        race: Race.HUMAN,
        alignment: Alignment.GOOD,
        stats: validStats,
        selectedClass: CharacterClass.FIGHTER
      })

      expect(char.strength).toBe(15)
      expect(char.intelligence).toBe(12)
      expect(char.piety).toBe(12)
      expect(char.vitality).toBe(14)
      expect(char.agility).toBe(11)
      expect(char.luck).toBe(10)
    })

    it('generates unique character ID', () => {
      const char1 = CharacterService.createCharacter({
        name: 'Char1',
        password: 'test',
        race: Race.HUMAN,
        alignment: Alignment.GOOD,
        stats: validStats,
        selectedClass: CharacterClass.FIGHTER
      })

      const char2 = CharacterService.createCharacter({
        name: 'Char2',
        password: 'test',
        race: Race.HUMAN,
        alignment: Alignment.GOOD,
        stats: validStats,
        selectedClass: CharacterClass.FIGHTER
      })

      expect(char1.id).toBeDefined()
      expect(char2.id).toBeDefined()
      expect(char1.id).not.toBe(char2.id)
    })

    it('initializes character with empty inventory', () => {
      const char = CharacterService.createCharacter({
        name: 'Test',
        password: 'test',
        race: Race.HUMAN,
        alignment: Alignment.GOOD,
        stats: validStats,
        selectedClass: CharacterClass.FIGHTER
      })

      expect(char.inventory).toEqual([])
    })

    it('initializes character with 0 gold', () => {
      const char = CharacterService.createCharacter({
        name: 'Test',
        password: 'test',
        race: Race.HUMAN,
        alignment: Alignment.GOOD,
        stats: validStats,
        selectedClass: CharacterClass.FIGHTER
      })

      expect(char.gold).toBe(0)
    })

    it('calculates starting HP based on class and vitality', () => {
      const fighterChar = CharacterService.createCharacter({
        name: 'Fighter',
        password: 'test',
        race: Race.HUMAN,
        alignment: Alignment.GOOD,
        stats: { ...validStats, vitality: 14 },
        selectedClass: CharacterClass.FIGHTER
      })

      const mageChar = CharacterService.createCharacter({
        name: 'Mage',
        password: 'test',
        race: Race.HUMAN,
        alignment: Alignment.GOOD,
        stats: { ...validStats, vitality: 14 },
        selectedClass: CharacterClass.MAGE
      })

      // Fighter should have higher HP than Mage with same vitality
      expect(fighterChar.hp).toBeGreaterThan(mageChar.hp)
      expect(fighterChar.maxHp).toBeGreaterThan(mageChar.maxHp)
    })

    it('throws error when character does not meet class requirements', () => {
      const lowStats: BaseStats = {
        strength: 8,
        intelligence: 8,
        piety: 8,
        vitality: 8,
        agility: 8,
        luck: 8
      }

      expect(() => {
        CharacterService.createCharacter({
          name: 'Test',
          password: 'test',
          race: Race.HUMAN,
          alignment: Alignment.GOOD,
          stats: lowStats,
          selectedClass: CharacterClass.SAMURAI // Requires high stats
        })
      }).toThrow('does not meet requirements for SAMURAI')
    })
  })
```

### Step 2: Run test to verify it fails

Run: `npm test -- --ci --testPathPattern="CharacterService"`

Expected: FAIL (createCharacter not defined)

### Step 3: Implement character creation method

**Files:**
- Modify: `src/services/CharacterService.ts`

Add imports and type:

```typescript
import { Character } from '../types/Character'
import { CharacterStatus } from '../types/CharacterStatus'
import { Race } from '../types/Race'
import { Alignment } from '../types/Alignment'
import { v4 as uuidv4 } from 'uuid'

export interface CreateCharacterInput {
  name: string
  password: string
  race: Race
  alignment: Alignment
  stats: BaseStats
  selectedClass: CharacterClass
}
```

Add to CharacterService:

```typescript
  /**
   * Create a new character with validated stats and class.
   *
   * Throws error if character does not meet class requirements.
   */
  static createCharacter(input: CreateCharacterInput): Character {
    const { name, password, race, alignment, stats, selectedClass } = input

    // Validate character meets class requirements
    const eligible = this.getEligibleClasses(stats)
    if (!eligible.includes(selectedClass)) {
      throw new Error(
        `Character does not meet requirements for ${selectedClass}`
      )
    }

    // Calculate starting HP based on class and vitality
    const { hp, maxHp } = this.calculateStartingHP(selectedClass, stats.vitality)

    // Create character
    const character: Character = {
      id: uuidv4(),
      name,
      password,
      race,
      alignment,
      class: selectedClass,
      level: 1,
      experience: 0,

      // Stats
      strength: stats.strength,
      intelligence: stats.intelligence,
      piety: stats.piety,
      vitality: stats.vitality,
      agility: stats.agility,
      luck: stats.luck,

      // HP
      hp,
      maxHp,

      // Status
      status: CharacterStatus.OK,

      // Inventory
      inventory: [],
      gold: 0
    }

    return character
  }

  /**
   * Calculate starting HP based on class and vitality.
   *
   * Formula (authentic Wizardry):
   * - Base HP varies by class
   * - Modified by vitality bonus
   */
  private static calculateStartingHP(
    characterClass: CharacterClass,
    vitality: number
  ): { hp: number; maxHp: number } {
    // Base HP by class (from original Wizardry)
    const baseHP: Record<CharacterClass, number> = {
      [CharacterClass.FIGHTER]: 10,
      [CharacterClass.MAGE]: 4,
      [CharacterClass.PRIEST]: 8,
      [CharacterClass.THIEF]: 6,
      [CharacterClass.BISHOP]: 4,
      [CharacterClass.SAMURAI]: 10,
      [CharacterClass.LORD]: 10,
      [CharacterClass.NINJA]: 8
    }

    // Vitality bonus: (VIT - 10) / 3, minimum 0
    const vitalityBonus = Math.max(0, Math.floor((vitality - 10) / 3))

    const maxHp = baseHP[characterClass] + vitalityBonus

    return { hp: maxHp, maxHp }
  }
```

### Step 4: Run test to verify it passes

Run: `npm test -- --ci --testPathPattern="CharacterService"`

Expected: PASS (all 29 tests passing - 12 class + 10 validation + 7 creation)

### Step 5: Commit

```bash
git add src/services/CharacterService.ts src/services/__tests__/CharacterService.spec.ts
git commit -m "feat(character): implement character creation logic

- Create character with all required attributes
- Generate unique character IDs (UUID)
- Validate class eligibility before creation
- Calculate starting HP based on class and vitality
- Initialize with empty inventory and 0 gold
- 7 tests passing (29 total)

Part of Phase 5: CharacterService implementation"
```

---

## Part 4: Install UUID Package

### Step 1: Install uuid package

Run: `npm install uuid`
Run: `npm install --save-dev @types/uuid`

### Step 2: Verify tests still pass

Run: `npm test -- --ci --testPathPattern="CharacterService"`

Expected: PASS (all 29 tests still passing with uuid import)

### Step 3: Commit

```bash
git add package.json package-lock.json
git commit -m "chore: add uuid package for character ID generation

Part of Phase 5: CharacterService implementation"
```

---

## Execution Summary

**Task 11.5 Complete:**
- ✅ Class eligibility calculation (12 tests)
- ✅ Name/password validation (10 tests)
- ✅ Character creation (7 tests)
- ✅ Total: 29 tests passing

**Files Created:**
- `src/services/CharacterService.ts`
- `src/services/__tests__/CharacterService.spec.ts`

**Files Modified:**
- `package.json` (added uuid dependency)

**Ready For:**
- Task 12: Training Grounds character creation wizard UI

---

## Notes for Implementation

**Reference Documentation:**
- `/docs/ui/scenes/02-training-grounds.md` - Character creation wizard flow
- `/docs/game-design/classes.md` - Class requirements and mechanics

**Testing Requirements:**
- All tests use real data (no mocks)
- Pure function testing pattern
- TDD cycle: write test → fail → implement → pass → commit

**Common Pitfalls:**
- Don't forget Ninja requires ALL stats at 17 (very rare!)
- Lord has the most requirements (6 stats)
- Starting HP calculation uses vitality bonus formula
- Character names max 15 chars, passwords 4-8 chars
